<?xml version="1.0" encoding="UTF-8"?>
<CPackWiXPatch>
  <!-- Add service installation functionality to the product -->
  <CPackWiXFragment Id="#PRODUCT">
    <!-- Custom actions for service management -->
    <CustomAction Id="CreateConfigDir" Execute="deferred" Impersonate="no" 
                  ExeCommand='cmd.exe /c "if not exist &quot;[CommonAppDataFolder]DDOSoft\ddogreen&quot; mkdir &quot;[CommonAppDataFolder]DDOSoft\ddogreen&quot;"' />
    
    <CustomAction Id="CopyDefaultConfig" Execute="deferred" Impersonate="no"
                  ExeCommand='cmd.exe /c "if not exist &quot;[CommonAppDataFolder]DDOSoft\ddogreen\ddogreen.conf&quot; copy /Y &quot;[INSTALLDIR]ddogreen.conf.default&quot; &quot;[CommonAppDataFolder]DDOSoft\ddogreen\ddogreen.conf&quot;"' />
    
    <CustomAction Id="InstallService" Execute="deferred" Impersonate="no"
                  ExeCommand='sc.exe create ddogreen binPath= &quot;[INSTALLDIR]ddogreen.exe --daemon --config [CommonAppDataFolder]DDOSoft\ddogreen\ddogreen.conf&quot; DisplayName= &quot;DDOGreen - Intelligent Green Power Management&quot; start= auto' />
    
    <CustomAction Id="ConfigureService" Execute="deferred" Impersonate="no"
                  ExeCommand='sc.exe description ddogreen &quot;Automatically manages Windows power plans based on system load monitoring for sustainable computing&quot;' />
    
    <CustomAction Id="SetServiceRecovery" Execute="deferred" Impersonate="no"
                  ExeCommand='sc.exe failure ddogreen reset= 86400 actions= restart/10000/restart/30000/restart/60000' />
    
    <CustomAction Id="StartService" Execute="deferred" Impersonate="no"
                  ExeCommand='sc.exe start ddogreen' />
    
    <CustomAction Id="StopService" Execute="deferred" Impersonate="no"
                  ExeCommand='sc.exe stop ddogreen' />
    
    <CustomAction Id="RemoveService" Execute="deferred" Impersonate="no"
                  ExeCommand='sc.exe delete ddogreen' />

    <!-- Installation sequence -->
    <InstallExecuteSequence>
      <Custom Action="CreateConfigDir" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="CopyDefaultConfig" After="CreateConfigDir">NOT Installed</Custom>
      <Custom Action="InstallService" After="CopyDefaultConfig">NOT Installed</Custom>
      <Custom Action="ConfigureService" After="InstallService">NOT Installed</Custom>
      <Custom Action="SetServiceRecovery" After="ConfigureService">NOT Installed</Custom>
      <Custom Action="StartService" After="SetServiceRecovery">NOT Installed</Custom>
      
      <!-- Uninstallation sequence -->
      <Custom Action="StopService" Before="RemoveFiles">Installed AND NOT REINSTALL</Custom>
      <Custom Action="RemoveService" After="StopService">Installed AND NOT REINSTALL</Custom>
    </InstallExecuteSequence>
  </CPackWiXFragment>
</CPackWiXPatch>