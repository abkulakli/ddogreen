<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Name="@CPACK_PACKAGE_NAME@"
           Language="1033"
           Version="@CPACK_PACKAGE_VERSION@"
           Manufacturer="@CPACK_PACKAGE_VENDOR@"
           UpgradeCode="@CPACK_WIX_UPGRADE_GUID@"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <!-- Install directories -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="ManufacturerFolder" Name="ddosoft">
        <Directory Id="INSTALLFOLDER" Name="ddogreen" />
      </Directory>
    </StandardDirectory>
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="CommonAppDataManufacturerFolder" Name="ddosoft">
        <Directory Id="CONFIGFOLDER" Name="ddogreen" />
      </Directory>
    </StandardDirectory>

    <!-- Files and service -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="MainFiles" Guid="F1E2D3C4-B5A6-7890-CDEF-123456789ABC">
        <File Id="ddogreen.exe" Source="@CPACK_TOPLEVEL_DIRECTORY@/bin/ddogreen.exe" KeyPath="yes" />
        <File Id="nssm.exe" Source="@CPACK_TOPLEVEL_DIRECTORY@/bin/nssm.exe" />
      </Component>
    </DirectoryRef>

    <!-- Custom actions to install/remove service using NSSM via cmd.exe -->
    <CustomAction Id="InstallService"
        Directory="INSTALLFOLDER"
        ExeCommand="cmd.exe /c &quot;nssm.exe install ddogreen ddogreen.exe&quot;"
        Execute="deferred"
        Impersonate="no"
        Return="ignore" />

    <CustomAction Id="ConfigureService"
        Directory="INSTALLFOLDER"
        ExeCommand="cmd.exe /c &quot;nssm.exe set ddogreen AppParameters --config [CONFIGFOLDER]ddogreen.conf&quot;"
        Execute="deferred"
        Impersonate="no"
        Return="ignore" />

    <CustomAction Id="SetServiceDisplayName"
        Directory="INSTALLFOLDER"
        ExeCommand="cmd.exe /c &quot;nssm.exe set ddogreen DisplayName &quot;DDOGreen - Intelligent Green Power Management&quot;&quot;"
        Execute="deferred"
        Impersonate="no"
        Return="ignore" />

    <CustomAction Id="SetServiceDescription"
        Directory="INSTALLFOLDER"
        ExeCommand="cmd.exe /c &quot;nssm.exe set ddogreen Description &quot;Automatically manages Windows power plans based on system load monitoring&quot;&quot;"
        Execute="deferred"
        Impersonate="no"
        Return="ignore" />

    <CustomAction Id="StartService"
        Directory="INSTALLFOLDER"
        ExeCommand="cmd.exe /c &quot;net start ddogreen&quot;"
        Execute="deferred"
        Impersonate="no"
        Return="ignore" />

    <CustomAction Id="StopService"
        Directory="INSTALLFOLDER"
        ExeCommand="cmd.exe /c &quot;net stop ddogreen&quot;"
        Execute="deferred"
        Impersonate="no"
        Return="ignore" />

    <CustomAction Id="RemoveService"
        Directory="INSTALLFOLDER"
        ExeCommand="cmd.exe /c &quot;nssm.exe remove ddogreen confirm&quot;"
        Execute="deferred"
        Impersonate="no"
        Return="ignore" />

    <DirectoryRef Id="CONFIGFOLDER">
      <Component Id="ConfigFiles" Guid="A9B8C7D6-E5F4-3210-9876-543210FEDCBA">
        <File Id="ddogreen.conf" Source="@CPACK_TOPLEVEL_DIRECTORY@/share/ddogreen/ddogreen.conf.default" Name="ddogreen.conf" />
        <CreateFolder />
      </Component>
    </DirectoryRef>

    <!-- What to install -->
    <Feature Id="Complete" Title="Complete" Level="1">
      <ComponentRef Id="MainFiles" />
      <ComponentRef Id="ConfigFiles" />
    </Feature>

    <!-- Install sequence for custom actions -->
    <InstallExecuteSequence>
      <!-- Execute deferred actions after files are installed -->
      <Custom Action="InstallService" After="InstallFiles" Condition="NOT Installed" />
      <Custom Action="ConfigureService" After="InstallService" Condition="NOT Installed" />
      <Custom Action="SetServiceDisplayName" After="ConfigureService" Condition="NOT Installed" />
      <Custom Action="SetServiceDescription" After="SetServiceDisplayName" Condition="NOT Installed" />
      <Custom Action="StartService" After="SetServiceDescription" Condition="NOT Installed" />
      
      <!-- Stop and remove service during uninstall -->
      <Custom Action="StopService" Before="RemoveService" Condition="REMOVE=&quot;ALL&quot;" />
      <Custom Action="RemoveService" Before="RemoveFiles" Condition="REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>

  </Package>
</Wix>
