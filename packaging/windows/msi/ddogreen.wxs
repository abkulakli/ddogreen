<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Name="@CPACK_PACKAGE_NAME@"
           Language="1033"
           Version="@CPACK_PACKAGE_VERSION@"
           Manufacturer="@CPACK_PACKAGE_VENDOR@"
           UpgradeCode="@CPACK_WIX_UPGRADE_GUID@"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <!-- Install directories -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="ManufacturerFolder" Name="DDOSoft">
        <Directory Id="INSTALLFOLDER" Name="ddogreen" />
      </Directory>
    </StandardDirectory>
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="CommonAppDataManufacturerFolder" Name="DDOSoft">
        <Directory Id="CONFIGFOLDER" Name="ddogreen" />
      </Directory>
    </StandardDirectory>

    <!-- Files and service -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="MainFiles" Guid="F1E2D3C4-B5A6-7890-CDEF-123456789ABC">
        <File Id="ddogreen.exe" Source="@CPACK_TOPLEVEL_DIRECTORY@/ddogreen-windows/bin/ddogreen.exe" />
        <File Id="nssm.exe" Source="@CPACK_TOPLEVEL_DIRECTORY@/ddogreen-windows/bin/nssm.exe" />
      </Component>
    </DirectoryRef>

    <!-- Custom actions to install/remove service using NSSM -->
    <CustomAction Id="InstallService"
        Directory="INSTALLFOLDER"
        ExeCommand='nssm.exe install ddogreen "[INSTALLFOLDER]ddogreen.exe"'
        Execute="deferred"
        Impersonate="no" />

    <CustomAction Id="ConfigureService"
        Directory="INSTALLFOLDER"
        ExeCommand='nssm.exe set ddogreen AppParameters "--config &quot;[CONFIGFOLDER]ddogreen.conf&quot;"'
        Execute="deferred"
        Impersonate="no" />

    <CustomAction Id="RemoveService"
        Directory="INSTALLFOLDER"
        ExeCommand='nssm.exe remove ddogreen confirm'
        Execute="deferred"
        Impersonate="no" />

    <DirectoryRef Id="CONFIGFOLDER">
      <Component Id="ConfigFiles" Guid="A9B8C7D6-E5F4-3210-9876-543210FEDCBA">
        <File Id="ddogreen.conf" Source="@CPACK_TOPLEVEL_DIRECTORY@/ddogreen-windows/share/ddogreen/ddogreen.conf.default" Name="ddogreen.conf" />
        <CreateFolder />
      </Component>
    </DirectoryRef>

    <!-- What to install -->
    <Feature Id="Complete" Title="Complete" Level="1">
      <ComponentRef Id="MainFiles" />
      <ComponentRef Id="ConfigFiles" />
    </Feature>

    <!-- Install sequence for custom actions -->
    <InstallExecuteSequence>
      <Custom Action="InstallService" After="InstallFiles" Condition="NOT Installed" />
      <Custom Action="ConfigureService" After="InstallService" Condition="NOT Installed" />
      <Custom Action="RemoveService" Before="RemoveFiles" Condition="REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>

  </Package>
</Wix>
