<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Name="@CPACK_PACKAGE_NAME@"
           Language="1033"
           Version="@CPACK_PACKAGE_VERSION@"
           Manufacturer="@CPACK_PACKAGE_VENDOR@"
           UpgradeCode="@CPACK_WIX_UPGRADE_GUID@"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <!-- Install directories -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="ManufacturerFolder" Name="DDOSoft">
        <Directory Id="INSTALLFOLDER" Name="ddogreen" />
      </Directory>
    </StandardDirectory>
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="CommonAppDataManufacturerFolder" Name="DDOSoft">
        <Directory Id="CONFIGFOLDER" Name="ddogreen" />
      </Directory>
    </StandardDirectory>

    <!-- Files and service -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="MainFiles">
        <File Id="ddogreen.exe" Source="@CPACK_TOPLEVEL_DIRECTORY@/ddogreen-windows/bin/ddogreen.exe" />

        <!-- Windows Service (must be in the same component as the service executable) -->
        <ServiceInstall Id="DDOGreenService"
            Name="ddogreen"
            DisplayName="DDOGreen - Power Management Service"
            Description="Manages Windows power plans based on system load"
            Type="ownProcess"
            Start="auto"
            Account="LocalSystem"
            ErrorControl="normal"
            Arguments='--config "[CONFIGFOLDER]ddogreen.conf"' />

        <!-- Service control: install/remove service but don't auto-start -->
        <ServiceControl Id="DDOGreenServiceControl"
            Name="ddogreen"
            Stop="both"
            Remove="uninstall"
            Wait="no" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="CONFIGFOLDER">
      <Component Id="ConfigFiles">
        <File Id="ddogreen.conf" Source="@CPACK_TOPLEVEL_DIRECTORY@/ddogreen-windows/share/ddogreen/ddogreen.conf.default" Name="ddogreen.conf" />
        <CreateFolder />
      </Component>
    </DirectoryRef>

    <!-- What to install -->
    <Feature Id="Complete" Title="Complete" Level="1">
      <ComponentRef Id="MainFiles" />
      <ComponentRef Id="ConfigFiles" />
    </Feature>

  </Package>
</Wix>
